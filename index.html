<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Core Data Model Visualizer</title>

    <!-- External Dependencies -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
            height: 100vh;
            overflow: hidden;
        }

        /* Header Styles */
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .app-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .toolbar {
            display: flex;
            gap: 0.5rem;
        }

        .toolbar button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .toolbar button:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Layout - Three Column */
        .app-main {
            display: flex;
            height: calc(100vh - 80px);
        }

        .left-sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e5e5e7;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .right-sidebar {
            width: 450px;
            background: white;
            border-left: 1px solid #e5e5e7;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* File Input Section */
        .file-input {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e5e7;
        }

        .folder-selector {
            border: 2px solid #d2d2d7;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #f9f9fa;
        }

        .folder-selector:hover {
            border-color: #007AFF;
            background: #f0f8ff;
        }

        .folder-selector p {
            margin: 0.5rem 0;
            color: #86868b;
        }

        .folder-selector p:first-child {
            font-weight: 600;
            color: #1d1d1f;
        }

        .file-inputs {
            margin-top: 1rem;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
        }

        .file-inputs input[type="file"] {
            display: none;
        }

        .file-input-button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            width: 100%;
            max-width: 250px;
        }

        .file-input-button:hover {
            background: #0056b3;
        }

        #folder-input {
            display: none;
        }

        /* Entity List Section */
        .entity-list {
            flex: 1;
            padding: 1.5rem;
        }

        .entity-list h3 {
            margin-bottom: 1rem;
            color: #1d1d1f;
            font-size: 1.1rem;
        }

        .search-container {
            margin-bottom: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e5e5e7;
            border-radius: 6px;
            font-size: 0.9rem;
            background: #f9f9fa;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #007AFF;
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .search-input::placeholder {
            color: #86868b;
        }

        .entity-item {
            background: #f9f9fa;
            border: 1px solid #e5e5e7;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .entity-item:hover {
            background: #f0f8ff;
            border-color: #007AFF;
        }

        .entity-item.selected {
            background: #007AFF;
            color: white;
            border-color: #007AFF;
        }

        .entity-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .entity-info {
            font-size: 0.8rem;
            color: #86868b;
        }

        .entity-item.selected .entity-info {
            color: rgba(255,255,255,0.8);
        }

        /* Right Sidebar - Entity Details */
        .entity-details {
            padding: 1.5rem;
        }

        .entity-details h3 {
            margin-bottom: 1rem;
            color: #1d1d1f;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .entity-details .entity-icon {
            width: 20px;
            height: 20px;
            background: #007AFF;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .details-section {
            margin-bottom: 2rem;
        }

        .details-section h4 {
            margin-bottom: 1rem;
            color: #1d1d1f;
            font-size: 1rem;
            font-weight: 600;
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            overflow: hidden;
            font-size: 0.85rem;
        }

        .details-table th {
            background: #f9f9fa;
            color: #1d1d1f;
            font-weight: 600;
            padding: 0.75rem 0.5rem;
            text-align: left;
            border-bottom: 1px solid #e5e5e7;
            font-size: 0.8rem;
        }

        .details-table td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
        }

        .details-table tr:last-child td {
            border-bottom: none;
        }

        .details-table tr:hover {
            background: #f9f9fa;
        }

        .table-name {
            font-weight: 600;
            color: #1d1d1f;
        }

        .table-type {
            color: #007AFF;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
        }

        .table-properties {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .property-tag {
            display: inline-block;
            background: #e5e5e7;
            color: #1d1d1f;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 500;
        }

        .property-tag.optional {
            background: #ff9500;
            color: white;
        }

        .property-tag.required {
            background: #34c759;
            color: white;
        }

        .property-tag.indexed {
            background: #007aff;
            color: white;
        }

        .property-tag.to-many {
            background: #af52de;
            color: white;
        }

        .property-tag.to-one {
            background: #5ac8fa;
            color: white;
        }

        .empty-table-message {
            color: #86868b;
            font-style: italic;
            padding: 2rem;
            text-align: center;
            background: #f9f9fa;
            border-radius: 8px;
        }

        /* Graph Container */
        #graph-container {
            flex: 1;
            position: relative;
            background: #ffffff;
        }

        #graph-container svg {
            width: 100%;
            height: 100%;
        }

        /* Graph Styles */
        .entity-node {
            cursor: pointer;
        }

        .entity-node rect {
            fill: #ffffff;
            stroke: #333333;
            stroke-width: 2;
            rx: 6;
        }

        .entity-node:hover rect {
            fill: #f0f8ff;
            stroke: #007AFF;
        }

        .entity-node.selected rect {
            fill: #007AFF;
            stroke: #005ce6;
        }

        .entity-node text {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 12px;
            pointer-events: none;
        }

        .entity-node .entity-title {
            font-weight: bold;
            font-size: 14px;
        }

        .entity-node.selected text {
            fill: white;
        }

        .entity-node .attribute {
            font-size: 11px;
            fill: #666;
        }

        .entity-node.selected .attribute {
            fill: rgba(255,255,255,0.9);
        }

        .relationship-link {
            stroke: #999;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .relationship-link.one-to-many {
            stroke: #007AFF;
        }

        .relationship-link.one-to-one {
            stroke: #34C759;
        }

        .relationship-link.many-to-many {
            stroke: #FF9500;
        }

        .relationship-link.selected {
            stroke: #FF3B30;
            stroke-width: 3;
        }

        .relationship-link.inheritance {
            stroke: #AF52DE;
            stroke-width: 2;
            stroke-dasharray: 8,4;
            marker-end: url(#inheritance-arrow);
        }

        /* Loading and Error States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #86868b;
            flex-direction: column;
            text-align: center;
        }

        .loading .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #86868b;
            text-align: center;
            padding: 2rem;
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state h4 {
            margin-bottom: 0.5rem;
            color: #1d1d1f;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .right-sidebar {
                width: 300px;
            }
        }

        @media (max-width: 768px) {
            .app-main {
                flex-direction: column;
            }

            .left-sidebar, .right-sidebar {
                width: 100%;
                height: 200px;
            }

            .app-header {
                padding: 1rem;
            }

            .app-header h1 {
                font-size: 1.2rem;
            }

            .toolbar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <h1>Core Data Model Visualizer</h1>
        <div class="toolbar">
            <!-- button id="export-svg">Export SVG</button -->
            <!-- button id="export-png">Export PNG</button -->
            <button id="reset-zoom">Reset View</button>
        </div>
    </header>

    <main class="app-main">
        <!-- Left Sidebar - File Input & Entity List -->
        <aside class="left-sidebar">
            <section class="file-input">
                <div id="folder-selector" class="folder-selector">
                    <p></p>
                    <p>Choose .xcdatamodeld </p>
                    <div class="file-inputs">
                        <button class="file-input-button" onclick="document.getElementById('folder-input').click()">
                            Select Folder
                        </button>
                    </div>
                    <input type="file" id="folder-input" webkitdirectory>
                </div>
            </section>

            <section class="entity-list">
                <h3>Entities</h3>
                <div class="search-container">
                    <input
                        type="text"
                        id="entity-search"
                        class="search-input"
                        placeholder="Search entities..."
                    >
                </div>
                <div id="entities-container">
                    <div class="loading">
                        <div class="icon">📊</div>
                        <div>No model loaded</div>
                    </div>
                </div>
            </section>
        </aside>

        <!-- Main Content - Graph View -->
        <section class="main-content">
            <div id="graph-container"></div>
        </section>

        <!-- Right Sidebar - Entity Details -->
        <aside class="right-sidebar">
            <div class="entity-details">
                <div class="empty-state">
                    <div class="icon">🎯</div>
                    <h4>Select an Entity</h4>
                    <p>Click on an entity in the graph or list to view its details</p>
                </div>
            </div>
        </aside>
    </main>

    <script>
        // Core Data Model Visualizer Application

        // File Type Detection
        class FileTypeDetector {
            static detectFileType(file) {
                if (file.name === 'contents' && file.webkitRelativePath) {
                    return 'xcdatamodel_contents';
                }
                if (file.webkitRelativePath && file.webkitRelativePath.includes('.xcdatamodeld')) {
                    return 'xcdatamodel_bundle';
                }
                return 'unknown';
            }
        }

        // Core Data Model Parser
        class CoreDataModelParser {
            parseXMLContents(xmlString) {
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(xmlString, 'application/xml');

                    // Check for parsing errors
                    const parserError = doc.querySelector('parsererror');
                    if (parserError) {
                        throw new Error('Invalid XML format');
                    }

                    const model = {
                        entities: this.extractEntities(doc),
                        version: doc.documentElement.getAttribute('systemVersion') || 'Unknown',
                        codeGeneration: doc.documentElement.getAttribute('documentVersion') || 'Unknown'
                    };

                    return this.resolveRelationships(model);
                } catch (error) {
                    console.error('Error parsing XML:', error);
                    throw error;
                }
            }

            extractEntities(doc) {
                const entities = [];
                const entityElements = doc.querySelectorAll('entity');

                entityElements.forEach(element => {
                    const entity = {
                        name: element.getAttribute('name') || 'Unknown',
                        representedClassName: element.getAttribute('representedClassName'),
                        parentEntity: element.getAttribute('parentEntity'),
                        attributes: this.extractAttributes(element),
                        relationships: this.extractRelationships(element),
                        fetchedProperties: this.extractFetchedProperties(element)
                    };
                    entities.push(entity);
                });

                return entities;
            }

            extractAttributes(entityElement) {
                const attributes = [];
                const attrElements = entityElement.querySelectorAll('attribute');

                attrElements.forEach(attr => {
                    attributes.push({
                        name: attr.getAttribute('name') || 'Unknown',
                        type: attr.getAttribute('attributeType') || 'Unknown',
                        optional: attr.getAttribute('optional') === 'YES',
                        defaultValue: attr.getAttribute('defaultValueString'),
                        indexed: attr.getAttribute('indexed') === 'YES'
                    });
                });

                return attributes;
            }

            extractRelationships(entityElement) {
                const relationships = [];
                const relElements = entityElement.querySelectorAll('relationship');

                relElements.forEach(rel => {
                    relationships.push({
                        name: rel.getAttribute('name') || 'Unknown',
                        destination: rel.getAttribute('destinationEntity'),
                        toMany: rel.getAttribute('toMany') === 'YES',
                        optional: rel.getAttribute('optional') === 'YES',
                        deleteRule: rel.getAttribute('deletionRule') || 'No Action',
                        inverse: rel.getAttribute('inverseName')
                    });
                });

                return relationships;
            }

            resolveRelationships(model) {
                // Add back-references and validate relationships
                model.entities.forEach(entity => {
                    entity.relationships.forEach(rel => {
                        const targetEntity = model.entities.find(e => e.name === rel.destination);
                        if (!targetEntity) {
                            console.warn(`Target entity '${rel.destination}' not found for relationship '${rel.name}' in entity '${entity.name}'`);
                        }
                    });
                });

                return model;
            }

            extractFetchedProperties(entityElement) {
                const fetchedProperties = [];
                const fpElements = entityElement.querySelectorAll('fetchedProperty');

                fpElements.forEach(fp => {
                    fetchedProperties.push({
                        name: fp.getAttribute('name') || 'Unknown',
                        optional: fp.getAttribute('optional') === 'YES'
                    });
                });

                return fetchedProperties;
            }
        }

        // Graph Renderer using D3.js
        class DatabaseGraphRenderer {
            constructor(containerId) {
                this.containerId = containerId;
                this.container = d3.select(`#${containerId}`);
                this.container.selectAll('*').remove(); // Clear previous content

                this.width = 1200;
                this.height = 800;
                this.selectedNode = null;

                this.svg = this.container.append('svg')
                    .attr('width', '100%')
                    .attr('height', '100%')
                    .attr('viewBox', `0 0 ${this.width} ${this.height}`)
                    .attr('preserveAspectRatio', 'xMidYMid meet');

                // Add zoom behavior
                this.zoom = d3.zoom()
                    .scaleExtent([0.1, 3])
                    .on('zoom', (event) => {
                        this.g.attr('transform', event.transform);
                    });

                this.svg.call(this.zoom);

                // Create main group for zoomable content
                this.g = this.svg.append('g');

                // Add arrow markers for relationships
                this.addArrowMarkers();

                // Create force simulation
                this.simulation = d3.forceSimulation()
                    .force('link', d3.forceLink().id(d => d.id).distance(400))
                    .force('charge', d3.forceManyBody().strength(-2000))
                    .force('center', d3.forceCenter(this.width / 2, this.height / 2))
                    .force('collision', d3.forceCollide().radius(150));
            }

            addArrowMarkers() {
                const defs = this.svg.append('defs');

                // Standard arrow marker
                defs.append('marker')
                    .attr('id', 'arrowhead')
                    .attr('viewBox', '-0 -5 10 10')
                    .attr('refX', 8)
                    .attr('refY', 0)
                    .attr('orient', 'auto')
                    .attr('markerWidth', 8)
                    .attr('markerHeight', 8)
                    .attr('xoverflow', 'visible')
                    .append('svg:path')
                    .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
                    .attr('fill', '#999')
                    .style('stroke', 'none');

                // Inheritance arrow marker (triangle)
                defs.append('marker')
                    .attr('id', 'inheritance-arrow')
                    .attr('viewBox', '-0 -5 10 10')
                    .attr('refX', 8)
                    .attr('refY', 0)
                    .attr('orient', 'auto')
                    .attr('markerWidth', 8)
                    .attr('markerHeight', 8)
                    .attr('xoverflow', 'visible')
                    .append('svg:path')
                    .attr('d', 'M 0,-5 L 10 ,0 L 0,5 Z')
                    .attr('fill', 'none')
                    .attr('stroke', '#AF52DE')
                    .attr('stroke-width', 2);
            }

            renderModel(model) {
                this.model = model;
                const nodes = this.createNodes(model.entities);
                const links = this.createLinks(model.entities);

                this.updateSimulation(nodes, links);
                this.renderLinks(links);
                this.renderNodes(nodes);
            }

            createNodes(entities) {
                return entities.map(entity => ({
                    id: entity.name,
                    name: entity.name,
                    attributes: entity.attributes,
                    relationships: entity.relationships,
                    type: 'entity',
                    entity: entity
                }));
            }

            createLinks(entities) {
                const links = [];
                entities.forEach(entity => {
                    // Add relationship links
                    entity.relationships.forEach(rel => {
                        if (rel.destination) {
                            links.push({
                                source: entity.name,
                                target: rel.destination,
                                type: rel.toMany ? 'one-to-many' : 'one-to-one',
                                label: rel.name,
                                deleteRule: rel.deleteRule,
                                relationship: rel,
                                linkType: 'relationship'
                            });
                        }
                    });
                    
                    // Add inheritance links
                    if (entity.parentEntity) {
                        links.push({
                            source: entity.name,
                            target: entity.parentEntity,
                            type: 'inheritance',
                            label: 'inherits from',
                            linkType: 'inheritance'
                        });
                    }
                });
                return links;
            }

            updateSimulation(nodes, links) {
                this.simulation
                    .nodes(nodes)
                    .force('link')
                    .links(links);

                this.simulation.alpha(1).restart();
            }

            renderNodes(nodes) {
                const nodeGroups = this.g.selectAll('.entity-node')
                    .data(nodes, d => d.id)
                    .join('g')
                    .attr('class', 'entity-node')
                    .call(this.enableDrag());

                // Remove old content
                nodeGroups.selectAll('*').remove();

                // Calculate node dimensions
                nodes.forEach(node => {
                    node.width = 220;
                    // Base height + attributes + inheritance info (minimum 80px for inherited entities)
                    const baseHeight = 60;
                    const attributeHeight = node.attributes.length * 18;
                    const inheritanceHeight = node.entity.parentEntity ? 20 : 0;
                    node.height = Math.max(80, baseHeight + attributeHeight + inheritanceHeight);
                });

                // Add rectangles
                nodeGroups.append('rect')
                    .attr('width', d => d.width)
                    .attr('height', d => d.height)
                    .attr('x', d => -d.width / 2)
                    .attr('y', d => -d.height / 2);

                // Add entity name
                nodeGroups.append('text')
                    .attr('class', 'entity-title')
                    .attr('x', 0)
                    .attr('y', d => -d.height / 2 + 20)
                    .attr('text-anchor', 'middle')
                    .text(d => d.name);

                // Add separator line
                nodeGroups.append('line')
                    .attr('x1', d => -d.width / 2 + 10)
                    .attr('x2', d => d.width / 2 - 10)
                    .attr('y1', d => -d.height / 2 + 30)
                    .attr('y2', d => -d.height / 2 + 30)
                    .attr('stroke', '#ddd')
                    .attr('stroke-width', 1);

                // Add attributes
                nodeGroups.selectAll('.attribute')
                    .data(d => d.attributes)
                    .join('text')
                    .attr('class', 'attribute')
                    .attr('x', d => -100)
                    .attr('y', (d, i, nodes) => {
                        const parentNode = d3.select(nodes[i].parentNode).datum();
                        return -parentNode.height / 2 + 50 + (i * 18);
                    })
                    .text(d => `${d.name}: ${d.type}${d.optional ? '?' : ''}`);

                // Add inheritance information
                nodeGroups.filter(d => d.entity.parentEntity)
                    .append('text')
                    .attr('class', 'inheritance-info')
                    .attr('x', -100)
                    .attr('y', d => -d.height / 2 + 50 + (d.attributes.length * 18))
                    .attr('font-style', 'italic')
                    .attr('fill', '#007AFF')
                    .text(d => `⬆ inherits from ${d.entity.parentEntity}`);

                // Add click handlers
                nodeGroups.on('click', (event, d) => {
                    this.selectNode(d);
                    window.app.showEntityDetails(d.entity);
                });

                // Update positions on simulation tick
                this.simulation.on('tick', () => {
                    nodeGroups.attr('transform', d => `translate(${d.x}, ${d.y})`);
                    this.updateLinkPositions();
                });
            }

            renderLinks(links) {
                this.linkElements = this.g.selectAll('.relationship-link')
                    .data(links, d => `${d.source.id || d.source}-${d.target.id || d.target}`)
                    .join('path')
                    .attr('class', d => `relationship-link ${d.type}`)
                    .attr('marker-end', 'url(#arrowhead)');
            }

            updateLinkPositions() {
                if (this.linkElements) {
                    this.linkElements.attr('d', d => {
                        // Calculate path from source to target, accounting for node boundaries
                        const source = d.source;
                        const target = d.target;

                        if (!source || !target) return '';

                        const dx = target.x - source.x;
                        const dy = target.y - source.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance === 0) return '';

                        // Calculate edge points on node boundaries
                        const sourceRadius = Math.max(source.width || 100, source.height || 60) / 2;
                        const targetRadius = Math.max(target.width || 100, target.height || 60) / 2;

                        const sourceX = source.x + (dx / distance) * sourceRadius;
                        const sourceY = source.y + (dy / distance) * sourceRadius;
                        const targetX = target.x - (dx / distance) * targetRadius;
                        const targetY = target.y - (dy / distance) * targetRadius;

                        return `M ${sourceX} ${sourceY} L ${targetX} ${targetY}`;
                    });
                }
            }

            enableDrag() {
                return d3.drag()
                    .on('start', (event, d) => {
                        if (!event.active) this.simulation.alphaTarget(0.3).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                    })
                    .on('drag', (event, d) => {
                        d.fx = event.x;
                        d.fy = event.y;
                    })
                    .on('end', (event, d) => {
                        if (!event.active) this.simulation.alphaTarget(0);
                        d.fx = null;
                        d.fy = null;
                    });
            }

            selectNode(node) {
                // Update visual selection
                this.g.selectAll('.entity-node')
                    .classed('selected', d => d.id === node.id);

                this.selectedNode = node;

                // Highlight related relationships
                this.g.selectAll('.relationship-link')
                    .classed('selected', d => {
                        return (d.source.id === node.id || d.target.id === node.id);
                    });
            }

            updateEntityList() {
                if (this.selectedNode) {
                    const entityItems = document.querySelectorAll('.entity-item');
                    entityItems.forEach(item => {
                        item.classList.toggle('selected',
                            item.dataset.entityName === this.selectedNode.name);
                    });
                }
            }

            resetView() {
                this.svg.transition()
                    .duration(750)
                    .call(this.zoom.transform, d3.zoomIdentity);
            }
        }

        // Folder Selector Handler
        class FolderSelector {
            constructor(elementId, onFilesProcessed) {
                this.element = document.getElementById(elementId);
                this.onFilesProcessed = onFilesProcessed;
                this.setupEventListeners();
            }

            setupEventListeners() {
                this.element.addEventListener('click', this.showFilePicker.bind(this));

                // Folder input handler
                document.getElementById('folder-input').addEventListener('change', (e) => {
                    this.processFiles(Array.from(e.target.files));
                });
            }

            showFilePicker() {
                // This will be handled by button click
            }

            async processFiles(files) {
                console.log('Processing files:', files.map(f => f.name));

                for (const file of files) {
                    const fileType = FileTypeDetector.detectFileType(file);
                    console.log(`File: ${file.name}, Type: ${fileType}`);

                    try {
                        await this.handleFileByType(file, fileType);
                    } catch (error) {
                        console.error(`Error processing file ${file.name}:`, error);
                        this.showError(`Error processing ${file.name}: ${error.message}`);
                    }
                }
            }

            async handleFileByType(file, fileType) {
                switch (fileType) {
                    case 'xcdatamodel_contents':
                    case 'xcdatamodel_bundle':
                        await this.handleCoreDataFile(file);
                        break;
                    default:
                        // Try to parse as XML content if it's an XML file
                        if (file.name.endsWith('.xml') || file.type === 'text/xml') {
                            await this.handleCoreDataFile(file);
                        } else {
                            throw new Error(`Unsupported file type: ${file.name}. Please select a .xcdatamodeld folder.`);
                        }
                }
            }

            async handleCoreDataFile(file) {
                const xmlText = await file.text();
                const parser = new CoreDataModelParser();
                const model = parser.parseXMLContents(xmlText);

                if (this.onFilesProcessed) {
                    this.onFilesProcessed(model);
                }
            }

            showError(message) {
                const container = document.getElementById('entities-container');
                container.innerHTML = `<div class="error">${message}</div>`;
            }
        }

        // Main Application Controller
        class AppController {
            constructor() {
                this.currentModel = null;
                this.allEntities = [];
                this.graphRenderer = null;
                this.initializeComponents();
                this.setupEventListeners();
            }

            initializeComponents() {
                // Initialize folder selector
                this.folderSelector = new FolderSelector('folder-selector', (model) => {
                    this.loadModel(model);
                });

                // Initialize graph renderer
                this.graphRenderer = new DatabaseGraphRenderer('graph-container');
            }

            setupEventListeners() {
                // Entity search
                const searchInput = document.getElementById('entity-search');
                searchInput.addEventListener('input', (e) => {
                    this.filterEntities(e.target.value);
                });

                // Toolbar buttons
                document.getElementById('reset-zoom').addEventListener('click', () => {
                    if (this.graphRenderer) {
                        this.graphRenderer.resetView();
                    }
                });

                document.getElementById('export-svg').addEventListener('click', () => {
                    this.exportSVG();
                });

                document.getElementById('export-png').addEventListener('click', () => {
                    this.exportPNG();
                });
            }

            loadModel(model) {
                console.log('Loading model:', model);
                this.currentModel = model;
                this.allEntities = model.entities;

                // Clear search input
                document.getElementById('entity-search').value = '';

                // Update entity list
                this.updateEntityList(model.entities);

                // Render graph
                if (this.graphRenderer) {
                    this.graphRenderer.renderModel(model);
                }

                // Reset entity details to empty state
                this.showEmptyEntityDetails();
            }

            filterEntities(searchTerm) {
                if (!this.allEntities || this.allEntities.length === 0) {
                    return;
                }

                const filteredEntities = this.allEntities.filter(entity => {
                    // Search in entity name
                    if (entity.name.toLowerCase().includes(searchTerm.toLowerCase())) {
                        return true;
                    }

                    // Search in attribute names
                    if (entity.attributes.some(attr =>
                        attr.name.toLowerCase().includes(searchTerm.toLowerCase())
                    )) {
                        return true;
                    }

                    // Search in relationship names
                    if (entity.relationships.some(rel =>
                        rel.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        (rel.destination && rel.destination.toLowerCase().includes(searchTerm.toLowerCase()))
                    )) {
                        return true;
                    }

                    return false;
                });

                this.updateEntityList(filteredEntities);
            }

            updateEntityList(entities) {
                const container = document.getElementById('entities-container');

                if (entities.length === 0) {
                    container.innerHTML = '<div class="loading"><div class="icon">🔍</div><div>No entities found</div></div>';
                    return;
                }

                container.innerHTML = entities.map(entity => `
                    <div class="entity-item" data-entity-name="${entity.name}">
                        <div class="entity-name">${entity.name}</div>
                        <div class="entity-info">
                            ${entity.attributes.length} attributes,
                            ${entity.relationships.length} relationships
                            ${entity.parentEntity ? `<br>⬆ inherits from ${entity.parentEntity}` : ''}
                        </div>
                    </div>
                `).join('');

                // Add click handlers
                container.querySelectorAll('.entity-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const entityName = e.currentTarget.dataset.entityName;
                        const entity = entities.find(e => e.name === entityName);

                        if (entity && this.graphRenderer) {
                            const node = { id: entityName, name: entityName, entity: entity };
                            this.graphRenderer.selectNode(node);
                            this.showEntityDetails(entity);
                        }

                        // Update selection in entity list
                        container.querySelectorAll('.entity-item').forEach(el => {
                            el.classList.remove('selected');
                        });
                        e.currentTarget.classList.add('selected');
                    });
                });
            }

            showEntityDetails(entity) {
                const detailsContainer = document.querySelector('.entity-details');

                detailsContainer.innerHTML = `
                    <h3>
                        <span class="entity-icon">E</span>
                        ${entity.name}
                        ${entity.parentEntity ? `<br><small style="color: #007AFF; font-weight: normal;">⬆ inherits from ${entity.parentEntity}</small>` : ''}
                    </h3>

                    <div class="details-section">
                        <h4>Attributes (${entity.attributes.length})</h4>
                        ${entity.attributes.length > 0 ? `
                            <table class="details-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Properties</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${entity.attributes.map(attr => `
                                        <tr>
                                            <td class="table-name">${attr.name}</td>
                                            <td class="table-type">${attr.type}</td>
                                            <td class="table-properties">
                                                <span class="property-tag ${attr.optional ? 'optional' : 'required'}">
                                                    ${attr.optional ? 'Optional' : 'Required'}
                                                </span>
                                                ${attr.indexed ? '<span class="property-tag indexed">Indexed</span>' : ''}
                                                ${attr.defaultValue ? `<span class="property-tag">Default: ${attr.defaultValue}</span>` : ''}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<div class="empty-table-message">No attributes</div>'}
                    </div>

                    <div class="details-section">
                        <h4>Relationships (${entity.relationships.length})</h4>
                        ${entity.relationships.length > 0 ? `
                            <table class="details-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Destination</th>
                                        <th>Properties</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${entity.relationships.map(rel => `
                                        <tr>
                                            <td class="table-name">${rel.name}</td>
                                            <td class="table-type">${rel.destination || 'Unknown'}</td>
                                            <td class="table-properties">
                                                <span class="property-tag ${rel.toMany ? 'to-many' : 'to-one'}">
                                                    ${rel.toMany ? 'To Many' : 'To One'}
                                                </span>
                                                <span class="property-tag ${rel.optional ? 'optional' : 'required'}">
                                                    ${rel.optional ? 'Optional' : 'Required'}
                                                </span>
                                                <span class="property-tag">Delete: ${rel.deleteRule}</span>
                                                ${rel.inverse ? `<span class="property-tag">Inverse: ${rel.inverse}</span>` : ''}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<div class="empty-table-message">No relationships</div>'}
                    </div>

                    ${entity.representedClassName ? `
                    <div class="details-section">
                        <h4>Class Information</h4>
                        <table class="details-table">
                            <thead>
                                <tr>
                                    <th>Property</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="table-name">Class Name</td>
                                    <td class="table-type">${entity.representedClassName}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    ` : ''}
                `;
            }

            showEmptyEntityDetails() {
                const detailsContainer = document.querySelector('.entity-details');
                detailsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">🎯</div>
                        <h4>Select an Entity</h4>
                        <p>Click on an entity in the graph or list to view its details</p>
                    </div>
                `;
            }

            exportSVG() {
                if (!this.graphRenderer) return;

                const svgElement = document.querySelector('#graph-container svg');
                if (svgElement) {
                    const serializer = new XMLSerializer();
                    const svgString = serializer.serializeToString(svgElement);
                    const blob = new Blob([svgString], { type: 'image/svg+xml' });
                    saveAs(blob, 'core-data-model.svg');
                }
            }

            exportPNG() {
                // This would require html2canvas or similar library
                console.log('PNG export not yet implemented');
            }
        }

        // Initialize application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new AppController();
        });
    </script>
</body>
</html>